/* IMAGE UPLOAD InitEditor() */
// Updated image upload handler for Base64 conversion
    images_upload_handler: function (blobInfo, success, failure) {
        try {
            const reader = new FileReader();

            reader.onload = function () {
                const base64Image = reader.result; // Base64 string
                success(base64Image); // Pass Base64 to TinyMCE
            };

            reader.onerror = function () {
                failure('Failed to read file and convert to Base64.');
            };

            reader.readAsDataURL(blobInfo.blob()); // Convert image to Base64
        } catch (error) {
            failure('An error occurred: ' + error.message);
        }
    },

    // Updated file picker callback
    file_picker_callback: function (callback, value, meta) {
        if (meta.filetype === 'image') {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');

            input.onchange = function () {
                const file = this.files[0];
                const reader = new FileReader();

                reader.onload = function () {
                    const base64Image = reader.result; // Base64 string
                    callback(base64Image, { alt: file.name }); // Pass Base64 to TinyMCE
                };

                reader.onerror = function () {
                    console.error('Failed to read file and convert to Base64.');
                };

                reader.readAsDataURL(file); // Convert image to Base64
            };

            input.click();
        }
    }
/* END OF IT */

/* PHP MAILER */
$title = $_POST["title"];
    $content = $_POST["content"];

    // Autoload files if using Composer
    require 'vendor/autoload.php';

    $mail = new PHPMailer(true);

    try {
        // Server settings
        $mail->isSMTP();                                            // Send using SMTP
        $mail->Host       = 'smtp.gmail.com';                     // Set the SMTP server
        $mail->SMTPAuth   = true;                                   // Enable SMTP authentication
        $mail->Username   = 'yako.mailer@gmail.com';               // SMTP username
        $mail->Password   = 'fqcy btct skpv wlxx';                  // SMTP password
        $mail->SMTPSecure = PHPMailer::ENCRYPTION_STARTTLS;         // Enable TLS encryption
        $mail->Port       = 587;                                   // TCP port to connect to

        // Recipients
        $mail->setFrom('yako.mailer@gmail.com', 'Angaza Home Church');
        $mail->addAddress('georgekimagut@proton.me', 'George Kimagut'); // Add a recipient

        // Content
        $mail->isHTML(true);                                       // Set email format to HTML
        $mail->Subject = $title;
        $mail->Body    = $content;
        $mail->AltBody = $content;

        $mail->send();
        echo "1";
    } catch (Exception $e) {
        echo "Message could not be sent. Mailer Error: {$mail->ErrorInfo}";
    }

/* VIEW NEWSLETTER WITH ALL DETAILS */
$get_newsletters = $conn->query("select * from newsletters order by newsletter_id DESC");
    $count = mysqli_num_rows($get_newsletters);

    if ($count < 1) {
        $result = 2;
        echo json_encode($result);
    } else {
        $result = []; // Initialize result array
        while ($newsletter = mysqli_fetch_assoc($get_newsletters)) {
            // Extract newsletter attachments as an array
            $newsletter_attachments = explode(",", trim($newsletter['newsletter_attachments'], "{}"));

            // Prepare each newsletter with attachments
            $result[] = [
                'id' => $newsletter['newsletter_id'],
                'title' => $newsletter['newsletter_title'],
                'content' => $newsletter['newsletter_content'],
                'status' => $newsletter['newsletter_status'],
                'date' => $newsletter['created_at'],
                'attachments' => $newsletter_attachments // Add attachments array
            ];
        }
        echo json_encode($result); // Send result as JSON
    }